<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Image Messenger</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      background: #121212;
      color: white;
    }

    h2 { text-align: center; color: #ff4d4d; }

    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      box-sizing: border-box;
    }

    button {
      background-color: #ff4d4d;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #cc0000;
    }

    canvas { display: none; }

    #outputImage {
      display: none;
      max-width: 100%;
      margin-top: 15px;
      border: 2px solid #444;
    }

    #downloadLink {
      display: none;
      background: #ff4d4d;
      padding: 10px;
      color: white;
      border-radius: 5px;
      text-decoration: none;
    }

    #decodedMessageBox {
      margin-top: 20px;
      padding: 10px;
      background: #222;
      border: 1px solid #ff4d4d;
      border-radius: 6px;
      min-height: 40px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <h2>üîê Hide Message in Image</h2>
  <input type="file" id="imageInput" accept="image/*">
  <textarea id="messageInput" placeholder="Enter your secret message..."></textarea>
  <input type="password" id="passwordInput" placeholder="Password (optional)">
  <button onclick="encodeMessage()">Encrypt & Hide</button>
  <canvas id="canvas"></canvas>
  <img id="outputImage" />
  <a id="downloadLink" download="hidden.png">Download Image</a>

  <hr>

  <h2>üïµÔ∏è Reveal Message from Image</h2>
  <input type="file" id="decodeImageInput" accept="image/*">
  <input type="password" id="decodePasswordInput" placeholder="Password (if any)">
  <button onclick="decodeMessage()">Reveal Message</button>
  <div id="decodedMessageBox">üîì Hidden message will appear here...</div>

  <script>
    function encodeMessage() {
      const file = document.getElementById('imageInput').files[0];
      const message = document.getElementById('messageInput').value;
      const password = document.getElementById('passwordInput').value;

      if (!file || !message) return alert("Please select an image and enter a message.");

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.getElementById('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          let finalMsg = message;
          if (password) {
            finalMsg = CryptoJS.AES.encrypt(message, password).toString();
          }

          const msgBytes = new TextEncoder().encode(finalMsg);
          const msgLength = msgBytes.length;

          if (msgLength > 65535) return alert("Message too long!");

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          const totalBitsNeeded = (msgLength + 2) * 8;  // 2 bytes for length
          if (totalBitsNeeded > data.length / 4) {
            return alert("Message is too large for this image.");
          }

          // Encode length (2 bytes = 16 bits)
          const lengthBytes = [(msgLength >> 8) & 0xFF, msgLength & 0xFF];
          const fullBytes = new Uint8Array([...lengthBytes, ...msgBytes]);

          for (let i = 0; i < fullBytes.length; i++) {
            for (let bit = 0; bit < 8; bit++) {
              const dataIndex = i * 8 + bit;
              data[dataIndex * 4] = (data[dataIndex * 4] & 0xFE) | ((fullBytes[i] >> (7 - bit)) & 1);
            }
          }

          ctx.putImageData(imageData, 0, 0);
          const outputImage = document.getElementById('outputImage');
          outputImage.src = canvas.toDataURL();
          outputImage.style.display = "block";

          const downloadLink = document.getElementById('downloadLink');
          downloadLink.href = outputImage.src;
          downloadLink.style.display = "inline-block";
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function decodeMessage() {
      const file = document.getElementById('decodeImageInput').files[0];
      const password = document.getElementById('decodePasswordInput').value;

      if (!file) return alert("Please select an image.");

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.getElementById('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          const bits = [];
          for (let i = 0; i < data.length / 4; i++) {
            bits.push(data[i * 4] & 1);
          }

          // Decode length first (first 16 bits)
          let length = 0;
          for (let i = 0; i < 16; i++) {
            length = (length << 1) | bits[i];
          }

          const bytes = [];
          for (let i = 16; i < 16 + length * 8; i += 8) {
            let byte = 0;
            for (let j = 0; j < 8; j++) {
              byte = (byte << 1) | bits[i + j];
            }
            bytes.push(byte);
          }

          const msgBytes = new Uint8Array(bytes);
          const message = new TextDecoder().decode(msgBytes);

          try {
            if (password) {
              const decrypted = CryptoJS.AES.decrypt(message, password);
              const result = decrypted.toString(CryptoJS.enc.Utf8);
              if (!result) throw new Error("Incorrect password or decryption failed.");
              document.getElementById('decodedMessageBox').innerText = "üîì " + result;
            } else {
              document.getElementById('decodedMessageBox').innerText = "üîì " + message;
            }
          } catch (err) {
            alert("Error: " + err.message);
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  </script>

  <p style="text-align:center; margin-top: 20px; color:#ff4d4d;">By - Abhijeet</p>
</body>
</html>
